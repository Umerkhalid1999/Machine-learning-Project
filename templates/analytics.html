{% extends "base.html" %}

{% block title %}Analytics Dashboard - ConnectAI{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="display-5 fw-bold">
            <i class="fas fa-chart-bar text-info me-3"></i>
            Analytics Dashboard
        </h1>
        <p class="lead text-muted">Real-time performance metrics and business insights</p>
    </div>

    <!-- Platform Overview -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-globe me-2"></i>Platform Overview
                    </h5>
                </div>
                <div class="card-body" id="platformStats">
                    <div class="row text-center">
                        <div class="col-md-2">
                            <h3 class="text-primary mb-0" id="totalUsers">1,000</h3>
                            <small class="text-muted">Total Users</small>
                        </div>
                        <div class="col-md-2">
                            <h3 class="text-success mb-0" id="totalPosts">15,000</h3>
                            <small class="text-muted">Total Posts</small>
                        </div>
                        <div class="col-md-2">
                            <h3 class="text-warning mb-0" id="dailyActiveUsers">450</h3>
                            <small class="text-muted">Daily Active</small>
                        </div>
                        <div class="col-md-2">
                            <h3 class="text-info mb-0" id="contentApproved">2,156</h3>
                            <small class="text-muted">Content Approved</small>
                        </div>
                        <div class="col-md-2">
                            <h3 class="text-danger mb-0" id="contentBlocked">234</h3>
                            <small class="text-muted">Content Blocked</small>
                        </div>
                        <div class="col-md-2">
                            <h3 class="text-dark mb-0" id="systemUptime">99.9%</h3>
                            <small class="text-muted">System Uptime</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ML Models Performance -->
    <div class="row mb-5">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-shield-alt me-2"></i>Sentiment Analysis Model
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-3">
                        <div class="col-6">
                            <h4 class="text-success" id="sentimentAccuracy">89%</h4>
                            <small class="text-muted">Accuracy</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-info" id="sentimentResponseTime">< 1ms</h4>
                            <small class="text-muted">Response Time</small>
                        </div>
                    </div>
                    <!-- Simple HTML/CSS Sentiment Chart -->
                    <div class="sentiment-chart">
                        <div class="chart-legend mb-2">
                            <small class="text-muted">Sentiment Distribution</small>
                        </div>
                        <div class="progress-stack mb-2" style="height: 30px; border-radius: 15px; overflow: hidden;">
                            <div class="progress-bar bg-success" style="width: 45%; height: 100%; float: left;" title="Positive: 45%"></div>
                            <div class="progress-bar bg-danger" style="width: 25%; height: 100%; float: left;" title="Negative: 25%"></div>
                            <div class="progress-bar bg-secondary" style="width: 30%; height: 100%; float: left;" title="Neutral: 30%"></div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small><span class="badge bg-success">Positive 45%</span></small>
                            <small><span class="badge bg-danger">Negative 25%</span></small>
                            <small><span class="badge bg-secondary">Neutral 30%</span></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-thumbs-up me-2"></i>Recommendation System
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-3">
                        <div class="col-6">
                            <h4 class="text-success" id="recPrecision">78%</h4>
                            <small class="text-muted">Precision</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-info" id="recResponseTime">< 10ms</h4>
                            <small class="text-muted">Response Time</small>
                        </div>
                    </div>
                    <!-- Simple HTML/CSS Recommendation Chart -->
                    <div class="recommendation-chart">
                        <div class="chart-legend mb-3">
                            <small class="text-muted">Performance Metrics</small>
                        </div>
                        <div class="metric-bars">
                            <div class="metric-item mb-2">
                                <div class="d-flex justify-content-between">
                                    <span class="small">Precision</span>
                                    <span class="small fw-bold">78%</span>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-success" style="width: 78%"></div>
                                </div>
                            </div>
                            <div class="metric-item mb-2">
                                <div class="d-flex justify-content-between">
                                    <span class="small">Recall</span>
                                    <span class="small fw-bold">72%</span>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-info" style="width: 72%"></div>
                                </div>
                            </div>
                            <div class="metric-item">
                                <div class="d-flex justify-content-between">
                                    <span class="small">F1-Score</span>
                                    <span class="small fw-bold">75%</span>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-warning" style="width: 75%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Business Impact Metrics -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>Business Impact Analysis
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <!-- Simple HTML/CSS Business Impact Chart -->
                            <div class="business-chart">
                                <div class="chart-legend mb-3">
                                    <small class="text-muted">Business Impact Trends</small>
                                </div>
                                <div class="chart-container" style="height: 200px; position: relative; background: #f8f9fa; border-radius: 8px; padding: 20px;">
                                    <div class="chart-grid" style="position: absolute; top: 20px; left: 20px; right: 20px; bottom: 20px;">
                                        <!-- Grid lines -->
                                        <div style="position: absolute; width: 100%; height: 1px; background: #dee2e6; top: 0%;"></div>
                                        <div style="position: absolute; width: 100%; height: 1px; background: #dee2e6; top: 25%;"></div>
                                        <div style="position: absolute; width: 100%; height: 1px; background: #dee2e6; top: 50%;"></div>
                                        <div style="position: absolute; width: 100%; height: 1px; background: #dee2e6; top: 75%;"></div>
                                        <div style="position: absolute; width: 100%; height: 1px; background: #dee2e6; top: 100%;"></div>
                                        
                                        <!-- User Engagement Line -->
                                        <svg style="position: absolute; width: 100%; height: 100%;" viewBox="0 0 300 160">
                                            <polyline points="0,128 50,115 100,102 150,89 200,83 250,80" 
                                                     fill="none" stroke="#28a745" stroke-width="3" stroke-linecap="round"/>
                                            <circle cx="0" cy="128" r="4" fill="#28a745"/>
                                            <circle cx="50" cy="115" r="4" fill="#28a745"/>
                                            <circle cx="100" cy="102" r="4" fill="#28a745"/>
                                            <circle cx="150" cy="89" r="4" fill="#28a745"/>
                                            <circle cx="200" cy="83" r="4" fill="#28a745"/>
                                            <circle cx="250" cy="80" r="4" fill="#28a745"/>
                                        </svg>
                                        
                                        <!-- Content Quality Line -->
                                        <svg style="position: absolute; width: 100%; height: 100%;" viewBox="0 0 300 160">
                                            <polyline points="0,112 50,102 100,89 150,76 200,70 250,64" 
                                                     fill="none" stroke="#007bff" stroke-width="3" stroke-linecap="round"/>
                                            <circle cx="0" cy="112" r="4" fill="#007bff"/>
                                            <circle cx="50" cy="102" r="4" fill="#007bff"/>
                                            <circle cx="100" cy="89" r="4" fill="#007bff"/>
                                            <circle cx="150" cy="76" r="4" fill="#007bff"/>
                                            <circle cx="200" cy="70" r="4" fill="#007bff"/>
                                            <circle cx="250" cy="64" r="4" fill="#007bff"/>
                                        </svg>
                                    </div>
                                    
                                    <!-- X-axis labels -->
                                    <div class="d-flex justify-content-between mt-2" style="font-size: 0.75rem; color: #6c757d;">
                                        <span>Jan</span>
                                        <span>Feb</span>
                                        <span>Mar</span>
                                        <span>Apr</span>
                                        <span>May</span>
                                        <span>Jun</span>
                                    </div>
                                </div>
                                
                                <!-- Legend -->
                                <div class="mt-3">
                                    <span class="badge bg-success me-2">
                                        <i class="fas fa-circle me-1"></i>User Engagement
                                    </span>
                                    <span class="badge bg-primary">
                                        <i class="fas fa-circle me-1"></i>Content Quality Score
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h6 class="fw-bold">Key Improvements</h6>
                            <ul class="list-unstyled">
                                <li class="mb-2">
                                    <span class="badge bg-success me-2">+40%</span>
                                    User Retention Rate
                                </li>
                                <li class="mb-2">
                                    <span class="badge bg-success me-2">+75%</span>
                                    Recommendation CTR
                                </li>
                                <li class="mb-2">
                                    <span class="badge bg-success me-2">-60%</span>
                                    Moderation Costs
                                </li>
                                <li class="mb-2">
                                    <span class="badge bg-success me-2">+25%</span>
                                    User Engagement
                                </li>
                                <li class="mb-2">
                                    <span class="badge bg-primary me-2">240%</span>
                                    Projected ROI
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Real-time Activity -->
    <div class="row mb-5">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-warning text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-clock me-2"></i>Real-time Content Moderation
                    </h6>
                </div>
                <div class="card-body">
                    <div id="moderationActivity" style="height: 300px; overflow-y: auto; scroll-behavior: smooth; position: relative;">
                        <!-- Real-time moderation logs will appear here -->
                        <div class="text-muted text-center p-3">
                            <i class="fas fa-clock me-2"></i>
                            Waiting for moderation events...
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-users me-2"></i>Recommendation Activity
                    </h6>
                </div>
                <div class="card-body">
                    <div id="recommendationActivity" style="height: 300px; overflow-y: auto; scroll-behavior: smooth; position: relative;">
                        <!-- Real-time recommendation logs will appear here -->
                        <div class="text-muted text-center p-3">
                            <i class="fas fa-thumbs-up me-2"></i>
                            Waiting for recommendation events...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Health -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-server me-2"></i>System Health & Performance
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="progress mb-2" style="height: 10px;">
                                <div class="progress-bar bg-success" role="progressbar" style="width: 75%"></div>
                            </div>
                            <small>CPU Usage: 75%</small>
                        </div>
                        <div class="col-md-3">
                            <div class="progress mb-2" style="height: 10px;">
                                <div class="progress-bar bg-info" role="progressbar" style="width: 60%"></div>
                            </div>
                            <small>Memory Usage: 60%</small>
                        </div>
                        <div class="col-md-3">
                            <div class="progress mb-2" style="height: 10px;">
                                <div class="progress-bar bg-warning" role="progressbar" style="width: 45%"></div>
                            </div>
                            <small>Storage Usage: 45%</small>
                        </div>
                        <div class="col-md-3">
                            <div class="progress mb-2" style="height: 10px;">
                                <div class="progress-bar bg-success" role="progressbar" style="width: 95%"></div>
                            </div>
                            <small>API Health: 95%</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
@keyframes fadeInDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Smooth scrolling for activity containers */
#moderationActivity, #recommendationActivity {
    scroll-behavior: smooth !important;
}

/* Prevent layout shifts when content is added */
#moderationActivity .alert, #recommendationActivity .alert {
    margin-bottom: 0.5rem !important;
    transition: all 0.3s ease;
}

/* Stable container heights */
.analytics-container {
    min-height: 300px;
    max-height: 300px;
}

/* Chart styling for HTML/CSS charts */
.progress-stack {
    display: flex;
    overflow: hidden;
}

.chart-container svg {
    pointer-events: none;
}
</style>

<script>
// Immediately prevent any scrolling on page load
window.scrollTo(0, 0);

// Initialize analytics dashboard
document.addEventListener('DOMContentLoaded', function() {
    // Ensure we stay at the top
    window.scrollTo(0, 0);
    
    // Start updates after a short delay
    setTimeout(() => {
        startRealTimeUpdates();
        updatePlatformStats();
    }, 1000);
});

function startRealTimeUpdates() {
    const moderationDiv = document.getElementById('moderationActivity');
    const recommendationDiv = document.getElementById('recommendationActivity');
    
    setInterval(() => {
        addModerationEvent(moderationDiv);
    }, 15000);
    
    setInterval(() => {
        addRecommendationEvent(recommendationDiv);
    }, 18000);
}

function addModerationEvent(container) {
    const placeholder = container.querySelector('.text-muted.text-center');
    if (placeholder) {
        placeholder.remove();
    }
    
    const events = [
        { action: 'APPROVE', text: 'Love this new feature!', sentiment: 'Positive' },
        { action: 'BLOCK', text: 'This is terrible garbage...', sentiment: 'Negative' },
        { action: 'REVIEW', text: 'Not sure about this update', sentiment: 'Neutral' }
    ];
    
    const event = events[Math.floor(Math.random() * events.length)];
    const timestamp = new Date().toLocaleTimeString();
    const colors = { 'APPROVE': 'success', 'REVIEW': 'warning', 'BLOCK': 'danger' };
    
    const eventHtml = `
        <div class="alert alert-${colors[event.action]} alert-sm mb-2">
            <small>
                <strong>${timestamp}</strong> - 
                <span class="badge bg-${colors[event.action]}">${event.action}</span>
                "${event.text.substring(0, 30)}..." 
                (${event.sentiment})
            </small>
        </div>
    `;
    
    const scrollTop = container.scrollTop;
    container.insertAdjacentHTML('afterbegin', eventHtml);
    container.scrollTop = scrollTop;
    
    while (container.children.length > 6) {
        container.removeChild(container.lastChild);
    }
}

function addRecommendationEvent(container) {
    const placeholder = container.querySelector('.text-muted.text-center');
    if (placeholder) {
        placeholder.remove();
    }
    
    const events = [
        { user: 'User 23', items: 5, avgRating: 4.2 },
        { user: 'User 45', items: 3, avgRating: 3.8 },
        { user: 'User 67', items: 4, avgRating: 4.5 }
    ];
    
    const event = events[Math.floor(Math.random() * events.length)];
    const timestamp = new Date().toLocaleTimeString();
    
    const eventHtml = `
        <div class="alert alert-info alert-sm mb-2">
            <small>
                <strong>${timestamp}</strong> - 
                Generated ${event.items} recommendations for ${event.user}
                (Avg Rating: ${event.avgRating}/5.0)
            </small>
        </div>
    `;
    
    const scrollTop = container.scrollTop;
    container.insertAdjacentHTML('afterbegin', eventHtml);
    container.scrollTop = scrollTop;
    
    while (container.children.length > 6) {
        container.removeChild(container.lastChild);
    }
}

function updatePlatformStats() {
    fetch('/api/stats')
    .then(response => response.json())
    .then(data => {
        document.getElementById('totalUsers').textContent = (data.total_users || 0).toLocaleString();
        document.getElementById('totalPosts').textContent = (data.total_posts || 0).toLocaleString();
        document.getElementById('dailyActiveUsers').textContent = (data.active_users || 0).toLocaleString();
        document.getElementById('contentApproved').textContent = (data.content_approved || 0).toLocaleString();
        document.getElementById('contentBlocked').textContent = (data.content_blocked || 0).toLocaleString();
        
        const sentimentAccuracy = data.moderation_accuracy || 0;
        const recPrecision = data.recommendation_precision || 0;
        
        document.getElementById('sentimentAccuracy').textContent = Math.round(sentimentAccuracy * 100) + '%';
        document.getElementById('recPrecision').textContent = Math.round(recPrecision * 100) + '%';
        
        console.log('Analytics updated with real data');
    })
    .catch(error => {
        console.log('Stats update error:', error);
    });
}

// Update stats every 60 seconds
setInterval(updatePlatformStats, 60000);
</script>
{% endblock %} 